<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Flight Overlay</title>
<style>
body {
    margin:0; padding:0; background-color:transparent;
    font-family: "Consolas","Courier New",monospace;
    font-weight:400;
    font-size:12px;
    overflow:hidden;
    color:#E0E0E0;
    text-shadow: 0 0 3px rgba(0,0,0,0.7);
}
.panel {
    position: fixed;
    top: 50px;
    right: 10px;
    width: 16vw;
    height: 70vh;
    padding: 15px;
    box-sizing: border-box;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    opacity: 0;
    transition: opacity 0.6s ease;
    overflow-y: auto;
    border-radius: 20px;
    pointer-events: none;
}
.panel.visible {
    opacity: 1;
    pointer-events: auto;
}

/* Flugdaten */
#overlayContainer {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    line-height:1.2;
    font-size:12px;
}
.overlayLine { 
    margin:2px 0; 
    display:flex; 
    justify-content: space-between; 
}
#overlayContainer h2 {
    font-size:14px;
    margin-bottom:6px;
    text-decoration: underline;
    font-weight:500;
}

/* Kopierte Flugdaten */
#copyOverlayContainer {
    margin-top:10px;
    border-top:1px solid #888;
    padding-top:6px;
}
#copyOverlayContainer h2 {
    font-size:13px;
    margin-bottom:4px;
    font-weight:500;
    text-decoration: underline;
}

/* Passagierliste */
#passengerListContainer h2 {
    font-size:14px;
    margin-bottom:4px;
    text-decoration: underline;
    font-weight:500;
}
pre#passengerList {
    margin:0; 
    white-space:pre-wrap; 
    font-family:"Consolas","Courier New",monospace; 
    font-size:12px;
}

/* Map & SeatMap */
#map { width:100%; height:100%; border-radius:20px; }
#seatMapPanel img { max-width:100%; max-height:100%; display:block; margin:auto; border-radius:20px; }

/* Debug Panel */
#debugPanel {
    top:10px;
    right:10px;
    width:auto; height:auto; padding:6px;
    background:rgba(0,0,0,0.6);
    font-size:11px; opacity:1;
    pointer-events:none; border-radius:8px;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
</head>
<body>

<!-- Panels -->
<div class="panel" id="flightDataPanel">
    <div id="overlayContainer">
        <h2>Flugdaten</h2>
        <div class="overlayLine" id="aircraftTypeLine"><span>Aircraft:</span><span id="aircraftType">---</span></div>
        <div class="overlayLine" id="depLine"><span>DEP:</span><span id="dep">---</span></div>
        <div class="overlayLine" id="arrLine"><span>ARR:</span><span id="arr">---</span></div>
        <div class="overlayLine" id="altitudeLine"><span>Altitude:</span><span id="altitude">---</span></div>
        <div class="overlayLine" id="groundSpeedLine"><span>Speed:</span><span id="groundSpeed">---</span></div>
        <div class="overlayLine" id="headingLine"><span>Heading:</span><span id="heading">---</span></div>
        <div class="overlayLine" id="vSpeedLine"><span>VSpeed:</span><span id="vSpeed">---</span></div>
        <div class="overlayLine" id="coordinatesLine"><span>Coords:</span><span id="coordinates">---</span></div>
    </div>

    <!-- Kopierte Flugdaten -->
    <div id="copyOverlayContainer">
        <h2>Kopierte Flugdaten</h2>
        <div class="overlayLine"><span>Altitude Copy:</span><span id="altitudeCopy">---</span></div>
        <div class="overlayLine"><span>Speed Copy:</span><span id="speedCopy">---</span></div>
        <div class="overlayLine"><span>Heading Copy:</span><span id="headingCopy">---</span></div>
        <div class="overlayLine"><span>Coords Copy:</span><span id="coordinatesCopy">---</span></div>
        <div class="overlayLine"><span>VSpeed Copy:</span><span id="vSpeedCopy">---</span></div>
    </div>
</div>

<div class="panel" id="mapPanel">
    <div id="map"></div>
</div>

<div class="panel" id="passengerPanel">
    <div id="passengerListContainer">
        <h2>Passagiere:</h2>
        <pre id="passengerList">Lade Passagierliste...</pre>
    </div>
</div>

<div class="panel" id="seatMapPanel">
    <img src="stuff/boarding_render.png" alt="Seat Map"/>
</div>

<!-- Debug Panel -->
<div class="panel" id="debugPanel">
    <span id="debugText">Panel: -, Intervall: -ms</span>
</div>

<script>
const SIMBRIDGE_URL = "http://localhost:8080/";
let panels = [];
let currentPanel = 0;
let rotationTimer = null;
let rotationInterval = 4000; // Default, wird überschrieben

// Leaflet Map
const map = L.map('map',{zoomControl:true}).setView([48,11],5);
const planeIcon = L.icon({ 
    iconUrl: new URL('./stuff/airplane_trans.png', location.href).href, 
    iconSize:[60,31], iconAnchor:[30,15] 
});
let planeMarker = null;
let currentPos=[48,11], targetPos=[48,11], heading=0, animating=false;

// OpenStreetMap Tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

// --- Daten abrufen ---
async function getData(){
    try{
        const res = await fetch(SIMBRIDGE_URL+'data');
        const data = await res.json();

        // Rotation Intervall übernehmen
        if(data.RotationInterval && !isNaN(data.RotationInterval)){
            rotationInterval = data.RotationInterval*1000;
        }

        // Panels synchronisieren
        const newPanels = [];
        if(data.ShowFlightData) newPanels.push('flightDataPanel');
        if(data.ShowMap)        newPanels.push('mapPanel');
        if(data.ShowPassenger)  newPanels.push('passengerPanel');
        if(data.ShowBoarding)   newPanels.push('seatMapPanel');

        // Panels aktualisieren, falls Änderung
        let changed = panels.join(",") !== newPanels.join(",");
        panels = newPanels;

        if(changed){
            currentPanel = 0;
            ['flightDataPanel','mapPanel','passengerPanel','seatMapPanel']
                .forEach(id => document.getElementById(id).classList.remove('visible'));
            if(panels.length>0){
                document.getElementById(panels[0]).classList.add('visible');
            }

            // Rotation neu starten
            if(rotationTimer) clearTimeout(rotationTimer);
            if(panels.length>1) rotationTimer = setTimeout(rotatePanels, rotationInterval);
        }

        // Flugdaten anzeigen
        document.getElementById("aircraftType").innerText = data.aircraftType || "---";
        document.getElementById("dep").innerText = data.dep || "---";
        document.getElementById("arr").innerText = data.arr || "---";
        document.getElementById("altitude").innerText = data.altitude!=null ? data.altitude.toFixed(0) : "---";
        document.getElementById("groundSpeed").innerText = data.speed!=null ? data.speed.toFixed(0) : "---";
        document.getElementById("heading").innerText = data.heading!=null ? data.heading.toFixed(0) : "---";
        document.getElementById("vSpeed").innerText = data.vSpeed!=null ? data.vSpeed.toFixed(0) : "---";
        document.getElementById("coordinates").innerText = (data.latitude!=null && data.longitude!=null) ? data.latitude.toFixed(6)+", "+data.longitude.toFixed(6) : "---";

        // Kopierte Flugdaten anzeigen
        document.getElementById("altitudeCopy").innerText = data.copyAltitude!=null ? data.copyAltitude.toFixed(0) : "---";
        document.getElementById("speedCopy").innerText = data.copySpeed!=null ? data.copySpeed.toFixed(0) : "---";
        document.getElementById("headingCopy").innerText = data.copyHeading!=null ? data.copyHeading.toFixed(0) : "---";
        document.getElementById("coordinatesCopy").innerText = (data.copyLatitude!=null && data.copyLongitude!=null) ? data.copyLatitude.toFixed(6)+", "+data.copyLongitude.toFixed(6) : "---";
        document.getElementById("vSpeedCopy").innerText = data.copyVSpeed!=null ? data.copyVSpeed.toFixed(0) : "---";

        // Zeilen sichtbar/nicht sichtbar
        document.getElementById("aircraftTypeLine").style.display = data.aircraftType ? "flex" : "none";
        document.getElementById("depLine").style.display = data.dep ? "flex" : "none";
        document.getElementById("arrLine").style.display = data.arr ? "flex" : "none";
        document.getElementById("altitudeLine").style.display = data.ShowAltitude ? "flex" : "none";
        document.getElementById("groundSpeedLine").style.display = data.ShowSpeed ? "flex" : "none";
        document.getElementById("headingLine").style.display = data.ShowHeading ? "flex" : "none";
        document.getElementById("vSpeedLine").style.display = data.ShowVSpeed ? "flex" : "none";
        document.getElementById("coordinatesLine").style.display = data.ShowPosition ? "flex" : "none";

        // Passagiere
        document.getElementById("passengerList").innerText = data.passengers?.join("\n") || "";

        // Map-Animation
        targetPos = [data.latitude||currentPos[0], data.longitude||currentPos[1]];
        heading = data.heading || 0;
        if(!animating && panels[currentPanel]==='mapPanel') animatePlane();

    } catch(err){ console.log("Fehler beim Abrufen der Daten",err); }
}

// Daten 1x/Sekunde abrufen
setInterval(getData,1000);

// --- Panel Rotation ---
function rotatePanels(){
    if(panels.length <= 1){
        rotationTimer = null;
        updateDebug();
        return;
    }

    document.getElementById(panels[currentPanel]).classList.remove('visible');
    currentPanel = (currentPanel+1)%panels.length;
    const panelId = panels[currentPanel];
    document.getElementById(panelId).classList.add('visible');

    if(panelId==='mapPanel'){ setTimeout(()=>{ map.invalidateSize(); map.setView(currentPos,map.getZoom(),{animate:false}); },100);}
    if(panelId==='seatMapPanel'){ const img = document.getElementById('seatMapPanel').querySelector('img'); if(img) img.src='stuff/boarding_render.png?t='+Date.now();}

    updateDebug();
    rotationTimer = setTimeout(rotatePanels, rotationInterval);
}

// --- Flugzeug Animation ---
function animatePlane(){
    animating=true;
    function step(){
        const dx = targetPos[0]-currentPos[0];
        const dy = targetPos[1]-currentPos[1];
        const speed = 0.05;
        currentPos[0]+=dx*speed;
        currentPos[1]+=dy*speed;

        if(!planeMarker){
            planeMarker = L.marker(currentPos,{icon:planeIcon, rotationAngle:heading, rotationOrigin:"center"}).addTo(map);
        } else {
            planeMarker.setLatLng(currentPos);
            planeMarker.setRotationAngle(heading);
        }

        map.setView(currentPos,map.getZoom(),{animate:false});
        if(Math.abs(dx)>0.00001 || Math.abs(dy)>0.00001) requestAnimationFrame(step);
        else animating=false;
    }
    requestAnimationFrame(step);
}

// --- Debug Panel ---
function updateDebug(){
    const panelName = panels.length>0 ? panels[currentPanel] : '-';
    document.getElementById('debugText').innerText = `Panel: ${panelName}, Intervall: ${rotationInterval}ms`;
}

// Initiales Debug Update
updateDebug();
</script>
</body>
</html>
